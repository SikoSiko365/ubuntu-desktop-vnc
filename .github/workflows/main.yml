name: Ubuntu VNC

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Install Desktop Environment & VNC
        run: |
          sudo apt update
          sudo apt install -y xfce4 xfce4-goodies tightvncserver git curl
          
          vncserver :1
          vncserver -kill :1

          mkdir -p ~/.vnc

          cat > ~/.vnc/xstartup <<EOF
#!/bin/bash
xrdb $HOME/.Xresources
startxfce4 &
EOF

          chmod +x ~/.vnc/xstartup

          vncserver :1 -geometry 1280x720 -depth 24

      - name: Setup noVNC Server
        run: |
          git clone https://github.com/novnc/noVNC.git ~/noVNC
          git clone https://github.com/novnc/websockify ~/noVNC/utils/websockify
          
          nohup ~/noVNC/utils/launch.sh --vnc localhost:5901 --listen 6080 > ~/novnc.log 2>&1 &

          sleep 10
          
          nohup ssh -o StrictHostKeyChecking=no -R 80:localhost:6080 serveo.net > serveo.log 2>&1 &
          
      - name: Display Access Info
        run: |
          echo "ğŸ”— After ~30 seconds, visit your public URL from serveo.net (check serveo.log output)"
          echo "ğŸ–¥ï¸ Then, connect using the VNC web interface at http://<your-serveo-subdomain>.serveo.net/vnc.html"
